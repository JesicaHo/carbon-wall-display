\<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ ¡åœ’æ¸›ç¢³å¤§ä½œæˆ° Â· çœ‹æ¿ç‰ˆ</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    /* === å¯èª¿åƒæ•¸ï¼ˆä¹Ÿæ”¯æ´ä»¥ URL Query è¦†è“‹ï¼‰ === */
    --scale: 0.85;                /* ç‰ˆé¢ç¸®æ”¾ */
    --refresh-ms: 30000;          /* è³‡æ–™/åœ–è¡¨é‡è¼‰é€±æœŸ(ms) */
    --autofs: 1;                  /* è‡ªå‹•å˜—è©¦é€²å…¥å…¨è¢å¹• (1|0) */

    /* === ä½ç½®åº§æ¨™ï¼ˆå¾®èª¿æ¨¡å¼æœƒå³æ™‚æ›´æ–° & å¯å„²å­˜ï¼‰ === */
    --peopleV-top: 39.45%; --peopleV-left: 22.34%;
    --foodV-top: 65.06%; --foodV-left: 29.12%;
    --transportV-top: 64.85%; --transportV-left: 72.95%;
    --plasticV-top: 83.87%; --plasticV-left: 30.07%;
    --moveV-top: 83.93%; --moveV-left: 72.01%;

    --chart-top: 38%; --chart-left: 69%;
    --chart-width: 62vw; --chart-height: 22vh;
  }

  html, body{
    margin:0; height:100%; background:#000; color:#111;
    font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif;
  }
  .stage{
    position:relative;
    width:calc(100vw/var(--scale));
    height:calc(100vh/var(--scale));
    transform:scale(var(--scale));
    transform-origin:top left;
    background:url("./é›»è¦–ç‰†1024.jpg") center/cover no-repeat;
    overflow:hidden;
    animation:tinyPulse 300s linear infinite; /* è¶…ä½é »ï¼Œé¿å…ç‡’è¢å¹• */
  }
  @keyframes tinyPulse{0%,97%,100%{opacity:1}98.5%{opacity:.985}}
  @media (prefers-reduced-motion: reduce){ .stage{ animation: none; } }

  .val{
    position:absolute; transform:translate(-50%,-50%);
    font-weight:800; letter-spacing:1px;
    text-shadow:0 1px 2px rgba(0,0,0,.15);
    font-size:5.8vh; color:#0b1b2b;
    user-select:none;
  }
  #peopleV{ color:#1b1b1b; top:var(--peopleV-top); left:var(--peopleV-left); }
  #foodV{ color:#0a48b3; top:var(--foodV-top); left:var(--foodV-left); }
  #transportV{ color:#0a8b4a; top:var(--transportV-top); left:var(--transportV-left); }
  #plasticV{ color:#c0392b; top:var(--plasticV-top); left:var(--plasticV-left); }
  #moveV{ color:#e67e22; top:var(--moveV-top); left:var(--moveV-left); }

  .chart-panel{
    position:absolute;
    top:var(--chart-top); left:var(--chart-left);
    width:var(--chart-width); height:var(--chart-height);
    transform:translate(-50%,-50%) scale(0.9);
    border-radius:12px; overflow:hidden;
    background:#ffffff00; box-shadow:0 4px 16px rgba(0,0,0,.25);
  }
  .chart-panel iframe{
    width:100%; height:100%; border:0; overflow:hidden !important;
    scrollbar-width:none !important;
  }
  .chart-panel iframe::-webkit-scrollbar{display:none !important;}

  #status{
    position:fixed; left:12px; bottom:12px; z-index:10;
    background:#fffE; padding:6px 10px; border-radius:8px;
    font-size:12px; font-weight:600; color:#111; opacity:.9;
  }
  #status[hidden]{ display:none; }
  
  /* === ç›´ç«‹è¢å¹•é è¨­åº§æ¨™ï¼ˆPortrait Preset Aï¼‰ ===
     è‹¥è¢å¹•è¼ƒçª„ï¼ˆæ‰‹æ©Ÿ/ç›´ç«‹çœ‹æ¿ï¼‰ï¼Œè‡ªå‹•æ”¹æˆå››è±¡é™æ’ç‰ˆï¼Œ
     è®“é•·æ¢åœ–åœ¨ä¸Šæ–¹ã€å››å¤§æŒ‡æ¨™åœ¨ä¸‹æ–¹å…©æ’ã€‚å¯å†æŒ‰ E å¾®èª¿ã€S å„²å­˜ã€‚ */
  @media (max-aspect-ratio: 10/16){
    :root{
      --scale: 0.86;
      /* åœ–è¡¨ç½®ä¸­åä¸Šã€åŠ å¯¬ */
      --chart-top: 38.3%;
      --chart-left: 69.7%;
      --chart-width: 74.8vw;
      --chart-height: 26vh;
      /* æŒ‡æ¨™åˆ†å››è±¡é™ï¼šå·¦ä¸Š/å³ä¸Š/å·¦ä¸‹/å³ä¸‹ */
      --peopleV-top: 42%;  --peopleV-left: 20%;  /* å¯ç”¨æ–¼æ”¾ã€Œäººæ¬¡ã€æˆ–å…¶ä»–æ•¸å€¼ */
      --foodV-top: 58%;    --foodV-left: 28%;
      --transportV-top: 58%; --transportV-left: 72%;
      --plasticV-top: 78%; --plasticV-left: 28%;
      --moveV-top: 78%;    --moveV-left: 72%;
    }
    .val{ font-size: 6.2vh; }
    .chart-panel{ transform: translate(-50%,-50%) scale(0.73); }
  }
</style>
</head>
<body>

<div class="stage" id="stage" aria-label="æ ¡åœ’æ¸›ç¢³çœ‹æ¿">
  <div id="peopleV" class="val" aria-label="äººå“¡æŒ‡æ¨™"><span id="v-people">--</span></div>
  <div id="foodV" class="val" aria-label="é£²é£ŸæŒ‡æ¨™"><span id="v-food">--</span></div>
  <div id="transportV" class="val" aria-label="é‹è¼¸æŒ‡æ¨™"><span id="v-transport">--</span></div>
  <div id="plasticV" class="val" aria-label="å¡‘è† æ¸›é‡æŒ‡æ¨™"><span id="v-plastic">--</span></div>
  <div id="moveV" class="val" aria-label="è¡Œå‹•åƒèˆ‡æŒ‡æ¨™"><span id="v-move">--</span></div>

  <!-- Google è©¦ç®—è¡¨åœ–è¡¨ -->
  <div class="chart-panel" id="chart-panel">
    <iframe
      id="chartFrame"
      title="æ¸›ç¢³è¶¨å‹¢åœ–"
      width="100%" height="100%"
      frameborder="0" scrolling="no"
      style="overflow:hidden;"
      src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTA18hRqu4Ch6iF2CukbRUQ0Ef8BDihdak7Cfkl7FzRacgKLc7Mynhvi06jkULpI5W1yBnepZpy61gA/pubchart?oid=558188415&amp;format=interactive">
    </iframe>
  </div>
</div>

<!-- è¢å¹•é–±è®€å™¨å‹å–„ç‹€æ…‹æ¢ -->
<div id="status" role="status" aria-live="polite">åˆå§‹åŒ–ä¸­â€¦ï¼ˆE å¾®èª¿ / F å…¨è¢å¹• / S å„²å­˜åº§æ¨™ / D é‡ç½®åº§æ¨™ï¼‰</div>

<script>
(()=>{
  // ====== å¯èª¿åƒæ•¸ï¼ˆå« URL Query è¦†è“‹ï¼‰ ======
  const params = new URLSearchParams(location.search);
  const API_EXEC = "https://script.google.com/macros/s/AKfycby7d9Zoo-JCCojFWN6aG10N8v5PYyTs3pjTReAGiuwU3aJoQUkBxU_2-0EBPdziMQcN/exec";
  const REFRESH_MS = +(params.get('refresh')||getCssNumber('--refresh-ms')||30000);
  const AUTO_FS = +(params.get('autofs')||getCssNumber('--autofs')||1) === 1;
  const SCALE = +(params.get('scale')||getCssNumber('--scale')||0.85);

  const nf = new Intl.NumberFormat('zh-Hant-TW', { maximumFractionDigits: 2 });
  const $ = id => document.getElementById(id);
  const st = t => { const el=$("status"); el.textContent=t; };

  // å¦‚æœä»¥ query æŒ‡å®š scaleï¼Œç«‹å³è¦†è“‹ CSS è®Šæ•¸
  if (!isNaN(SCALE)) document.documentElement.style.setProperty('--scale', String(SCALE));

  function getCssNumber(name){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return v ? parseFloat(v) : NaN;
  }

  // ====== æ•¸æ“šé¡¯ç¤º ======
  function show(d){
    $('v-people').textContent = nf.format(d.people ?? 0);
    $('v-food').textContent = nf.format(d.food ?? 0);
    $('v-transport').textContent = nf.format(d.transport ?? 0);
    $('v-plastic').textContent = nf.format(d.plastic ?? 0);
    $('v-move').textContent = nf.format(d.move ?? 0);
  }

  // ====== JSONP å–å¾—è³‡æ–™ï¼ˆå«é€¾æ™‚èˆ‡å–æ¶ˆï¼‰ ======
  let lastToken = 0;
  function loadOnce(){
    const token = ++lastToken;
    const cbName = `cb_${Date.now()}_${Math.random().toString(36).slice(2)}`;
    const url = `${API_EXEC}?callback=${cbName}&_ts=${Date.now()}`;
    const s = document.createElement('script');
    s.src = url; s.async = true; s.onerror = ()=> st('âŒ è³‡æ–™è¼‰å…¥å¤±æ•—');

    const timeout = setTimeout(()=>{
      // JSONP ç„¡æ³•ä¸­æ­¢ï¼Œä½†æˆ‘å€‘å¯ä»¥å¿½ç•¥é€¾æ™‚å›å‚³
      st('âŒ› é€£ç·šé€¾æ™‚ï¼Œç¨å¾Œè‡ªå‹•é‡è©¦â€¦');
      cleanup();
    }, Math.min(REFRESH_MS - 500, 10000));

    window[cbName] = (payload)=>{
      if (token !== lastToken) return; // å·²æœ‰æ›´æ–°çš„è«‹æ±‚ï¼Œå¿½ç•¥éæœŸå›æ‡‰
      try{
        if(!payload?.ok) throw new Error(payload?.error || 'API error');
        show(payload.data);
        st(`âœ… å·²æ›´æ–°ï¼š${payload.data.updatedAt||new Date().toLocaleString('zh-TW')}`);
        refreshChart();
      }catch(e){ st('âŒ '+ e.message); }
      cleanup();
    };

    function cleanup(){
      clearTimeout(timeout);
      delete window[cbName];
      s.remove();
    }

    document.body.appendChild(s);
  }

  // ====== Iframe åŒæ­¥é‡è¼‰ ======
  const chartFrame = $('chartFrame');
  const chartBase = chartFrame.getAttribute('src');
  function refreshChart(){
    // é¿å…æ±¡æŸ“ç€è¦½æ­·å²ï¼Œä½¿ç”¨ replace å±¬æ€§ï¼ˆä¸å¯è¡Œæ–¼ iframeï¼‰ï¼Œæ”¹ç‚ºåœ¨ src åŠ ç‰ˆæœ¬æˆ³
    chartFrame.src = chartBase + (chartBase.includes('?')?'&':'?') + '_ts=' + Date.now();
  }

  // ====== å¯è¦‹æ€§ï¼šèƒŒæ™¯æ™‚æš«åœè¼ªè©¢ ======
  let dataTimer = null, chartTimer = null;
  function startTimers(){
    stopTimers();
    loadOnce();
    dataTimer = setInterval(loadOnce, REFRESH_MS);
    chartTimer = setInterval(refreshChart, REFRESH_MS);
  }
  function stopTimers(){
    if (dataTimer) clearInterval(dataTimer), dataTimer=null;
    if (chartTimer) clearInterval(chartTimer), chartTimer=null;
  }
  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden) {
      st('â¸ å·²æš«åœæ›´æ–°ï¼ˆè¦–çª—èƒŒæ™¯ï¼‰');
      stopTimers();
    } else {
      st('â–¶ é‡æ–°å•Ÿå‹•æ›´æ–°â€¦');
      startTimers();
    }
  });
  window.addEventListener('pagehide', stopTimers);
  window.addEventListener('unload', stopTimers);

  // ç«‹å³å•Ÿå‹•
  startTimers();

  // ====== å…¨è¢å¹•ï¼ˆF éµã€é›™æ“Šï¼›å¯ç”¨ ?autofs=0 é—œé–‰è‡ªå‹•å˜—è©¦ï¼‰ ======
  const canFS = !!(document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen || document.documentElement.msRequestFullscreen || document.documentElement.mozRequestFullScreen);
  function enterFS(){
    const el=document.documentElement;
    (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||el.mozRequestFullScreen)?.call(el).catch?.(()=>{});
  }
  function exitFS(){
    (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen)?.call(document);
  }
  document.addEventListener('keydown',e=>{
    if(e.key.toLowerCase()==='f' && canFS){
      document.fullscreenElement ? exitFS() : enterFS();
    }
  });
  document.addEventListener('dblclick',()=>{ if(canFS) enterFS(); });
  if (AUTO_FS && canFS) {
    // å˜—è©¦ä¸€æ¬¡ï¼ˆæœ‰äº›ç€è¦½å™¨æœƒå¿½ç•¥ï¼Œç„¡å¦¨ï¼‰
    setTimeout(()=>enterFS(), 800);
  }

  // ====== å¾®èª¿æ¨¡å¼ï¼ˆE é–‹é—œ / S å„²å­˜è‡³ localStorage / D é‡ç½®ï¼‰ ======
  let tune=false, active=null;
  const ids=["peopleV","foodV","transportV","plasticV","moveV","chart-panel"];

  function setDraggable(ok){
    ids.forEach(id=>{
      const el=$(id);
      el.style.pointerEvents=ok?"auto":"none";
      el.style.cursor=ok?"move":"default";
    });
    st(ok?"ğŸ›  å¾®èª¿ä¸­ï¼ˆE é€€å‡º / S å„²å­˜åº§æ¨™ / D é‡ç½®ï¼‰":"âœ… æ›´æ–°å®Œæˆï¼ˆE å¾®èª¿ / F å…¨è¢å¹•ï¼‰");
  }
  document.addEventListener('keydown',e=>{
    const k=e.key.toLowerCase();
    if(k==='e'){ tune=!tune; setDraggable(tune); }
    if(k==='s' && tune){ savePositions(); }
    if(k==='d' && tune){ resetPositions(); }
  });

  ids.forEach(id=>{
    const el=$(id);
    el.addEventListener('pointerdown',e=>{ if(!tune) return; active=el; el.setPointerCapture(e.pointerId); });
    el.addEventListener('pointermove',e=>{
      if(!tune||active!==el)return;
      const r=$('stage').getBoundingClientRect();
      const x=((e.clientX-r.left)/r.width)*100;
      const y=((e.clientY-r.top)/r.height)*100;
      const xs = (Math.round(x*10)/10).toFixed(1)+"%"; // 0.1% å°é½Š
      const ys = (Math.round(y*10)/10).toFixed(1)+"%";
      document.documentElement.style.setProperty(`--${id}-left`, xs);
      document.documentElement.style.setProperty(`--${id}-top`, ys);
    });
    el.addEventListener('pointerup',()=>{ active=null; });
  });

  const LS_KEY='carbon-dash-positions';
  function savePositions(){
    const g=getComputedStyle(document.documentElement);
    const vars={};
    ids.forEach(id=>{
      vars[`--${id}-top`]=g.getPropertyValue(`--${id}-top`).trim();
      vars[`--${id}-left`]=g.getPropertyValue(`--${id}-left`).trim();
    });
    localStorage.setItem(LS_KEY, JSON.stringify(vars));
    navigator.clipboard?.writeText("/* è²¼å› :root{} å³å¯å›ºå®š */\n"+Object.entries(vars).map(([k,v])=>`${k}:${v};`).join("\n"));
    st('ğŸ’¾ å·²å„²å­˜åº§æ¨™ï¼ˆäº¦å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼‰');
  }
  function loadPositions(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const vars = JSON.parse(raw);
      for(const [k,v] of Object.entries(vars)){
        document.documentElement.style.setProperty(k, v);
      }
      st('ğŸ“¦ å·²è¼‰å…¥ä¸Šæ¬¡çš„åº§æ¨™é…ç½®');
    }catch{ /* ignore */ }
  }
  function resetPositions(){
    localStorage.removeItem(LS_KEY);
    st('â†© å·²æ¸…é™¤å·²å„²å­˜åº§æ¨™ï¼ˆé‡æ–°æ•´ç†å¾Œæ¢å¾©é è¨­ï¼‰');
  }
  loadPositions();
})();
</script>
</body>
</html>
