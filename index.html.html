<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>校園減碳大作戰｜數值與單位獨立定位 + 全螢幕 + 微調</title>
<style>
:root{
  /* 需要縮放再改這裡：0.80 ~ 0.90 都可，不影響座標 */
  --scale: 0.85;

  /* 第一列 */
  --foodV-top: 37.82%;  --foodV-left: 29.36%;
  --foodU-top: 42.93%;  --foodU-left: 41.29%;
  --transportV-top: 38.09%; --transportV-left: 70.74%;
  --transportU-top: 43.04%; --transportU-left: 81.83%;

  /* 第二列 */
  --plasticV-top: 56.60%; --plasticV-left: 30.76%;
  --plasticU-top: 61.71%; --plasticU-left: 40.54%;
  --moveV-top: 57.08%;    --moveV-left: 71.67%;
  --moveU-top: 61.92%;    --moveU-left: 83.13%;

  /* 第三列 */
  --peopleV-top: 84.53%;  --peopleV-left: 25.63%;
  --peopleU-top: 89.69%;  --peopleU-left: 38.21%;
  --totalV-top: 83.78%;   --totalV-left: 71.76%;
  --totalU-top: 89.69%;   --totalU-left: 84.72%;
}


html, body{
  margin:0; height:100%;
  font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:#000; color:#111;
}
.stage{
  position:relative;
  width:calc(100vw/var(--scale));
  height:calc(100vh/var(--scale));
  transform:scale(var(--scale));
  transform-origin:top left;
  background:url("./電視牆_電視牆2.jpg") center/cover no-repeat;
  overflow:hidden;
}

/* ===== 兩種元素：.val（數值）與 .unit-block（單位） ===== */
.val, .unit-block{
  position:absolute;
  transform:translate(-50%,-50%);  /* 以中心對準座標 */
  pointer-events:none;              /* 微調模式會打開 */
  text-shadow:0 1px 2px rgba(0,0,0,.15);
  font-weight:800; letter-spacing:1px;
}

/* 數值樣式（可依區塊上色） */
.val{ font-size:3.2vh; color:#0b1b2b; }
#foodV{ color:#0a48b3; }      #transportV{ color:#0a8b4a; }
#plasticV{ color:#c0392b; }   #moveV{ color:#e67e22; }
#peopleV{ color:#ffffff; }    #totalV{ color:#ffffff; }

/* 單位樣式（略小） */
.unit-block{ font-size:2.0vh; opacity:.85; color:#0b1b2b; }
#peopleU{ color:#ffffff; }    #totalU{ color:#ffffff; }

/* 位置綁定到 CSS 變數 */
#foodV     { top:var(--foodV-top);     left:var(--foodV-left); }
#foodU     { top:var(--foodU-top);     left:var(--foodU-left); }
#transportV{ top:var(--transportV-top);left:var(--transportV-left); }
#transportU{ top:var(--transportU-top);left:var(--transportU-left); }
#plasticV  { top:var(--plasticV-top);  left:var(--plasticV-left); }
#plasticU  { top:var(--plasticU-top);  left:var(--plasticU-left); }
#moveV     { top:var(--moveV-top);     left:var(--moveV-left); }
#moveU     { top:var(--moveU-top);     left:var(--moveU-left); }
#peopleV   { top:var(--peopleV-top);   left:var(--peopleV-left); }
#peopleU   { top:var(--peopleU-top);   left:var(--peopleU-left); }
#totalV    { top:var(--totalV-top);    left:var(--totalV-left); }
#totalU    { top:var(--totalU-top);    left:var(--totalU-left); }

/* 狀態與全螢幕按鈕 */
#status{
  position:fixed; left:12px; bottom:12px;
  background:rgba(255,255,255,.85);
  padding:6px 10px; border-radius:8px; font-size:14px; color:#111;
}
#fsBtn{
  position:fixed; right:14px; bottom:14px; z-index:10;
  border:0; border-radius:10px; padding:10px 14px;
  font-size:14px; font-weight:700; background:#0a7cff; color:#fff; cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,.25);
}
#fsBtn.hide{ display:none; }

/* 防燒印極小心跳 */
@keyframes tinyPulse{ 0%,97%,100%{opacity:1} 98.5%{opacity:.98} }
.stage{ animation: tinyPulse 300s linear infinite; }
</style>
</head>
<body>

<div class="stage" id="stage">
  <!-- 第一列：飲食 / 交通 -->
  <div id="foodV" class="val"><span id="v-food">--</span></div>
  <div id="foodU" class="unit-block">kgCO₂e</div>

  <div id="transportV" class="val"><span id="v-transport">--</span></div>
  <div id="transportU" class="unit-block">kgCO₂e</div>

  <!-- 第二列：減塑 / 移動 -->
  <div id="plasticV" class="val"><span id="v-plastic">--</span></div>
  <div id="plasticU" class="unit-block">kgCO₂e</div>

  <div id="moveV" class="val"><span id="v-move">--</span></div>
  <div id="moveU" class="unit-block">kgCO₂e</div>

  <!-- 第三列：人次 / 總減碳 -->
  <div id="peopleV" class="val"><span id="v-people">--</span></div>
  <div id="peopleU" class="unit-block">人次</div>

  <div id="totalV" class="val"><span id="v-total">--</span></div>
  <div id="totalU" class="unit-block">kgCO₂e</div>
</div>

<button id="fsBtn" title="F：全螢幕">進入全螢幕</button>
<div id="status">初始化中…（F 全螢幕 / E 微調 / S 複製座標）</div>

<script>
/* === 基本設定 === */
const API_EXEC = "https://script.google.com/macros/s/AKfycby7d9Zoo-JCCojFWN6aG10N8v5PYyTs3pjTReAGiuwU3aJoQUkBxU_2-0EBPdziMQcN/exec";
const REFRESH_MS = 30000;
const nf = new Intl.NumberFormat('zh-Hant-TW',{ maximumFractionDigits:2 });
const $ = (id) => document.getElementById(id);
const st = (t) => $("status").textContent = t;

/* === JSONP 讀取 === */
function show(m){
  $("v-food").textContent = nf.format(m.food);
  $("v-transport").textContent = nf.format(m.transport);
  $("v-plastic").textContent = nf.format(m.plastic);
  $("v-move").textContent = nf.format(m.move);
  $("v-people").textContent = nf.format(m.people);
  $("v-total").textContent = nf.format(m.total);
}
function onData(payload){
  try{
    if(!payload || !payload.ok) throw new Error(payload?.error || "API 回傳不正確");
    show(payload.data);
    st("✅ 成功載入（"+ payload.data.updatedAt +"）— F 全螢幕 / E 微調 / S 複製座標");
  }catch(e){ st("❌ 解析失敗："+ e.message); }
}
function loadOnce(){
  const s = document.createElement("script");
  s.src = API_EXEC + "?callback=onData&_ts=" + Date.now();
  s.onerror = () => st("❌ 載入失敗：請檢查部署或權限");
  document.body.appendChild(s);
}
loadOnce(); setInterval(loadOnce, REFRESH_MS);

/* === 全螢幕（F 切換） === */
async function enterFS(){ try{
  const el=document.documentElement;
  if(!document.fullscreenElement && el.requestFullscreen){ await el.requestFullscreen(); $("fsBtn").classList.add("hide"); }
}catch{} }
async function exitFS(){ try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch{} }
$("fsBtn").addEventListener("click", enterFS);
document.addEventListener("keydown", e=>{ const k=e.key.toLowerCase(); if(k==="f"){ document.fullscreenElement?exitFS():enterFS(); } });

/* === 防休眠 === */
let wakeTimer=null;
function keepAwake(){
  clearInterval(wakeTimer);
  wakeTimer = setInterval(()=>{ document.title=" "; setTimeout(()=>document.title="校園減碳大作戰",80); },120000);
}
keepAwake(); document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="visible") keepAwake(); });

/* === 微調模式（E 開/關、S 複製、拖曳、方向鍵微移） === */
let tune=false, active=null, current=null;
/* 可獨立調整的 ID：每個數值 V 與單位 U 都列進來 */
const ids=["foodV","foodU","transportV","transportU","plasticV","plasticU","moveV","moveU","peopleV","peopleU","totalV","totalU"];

function setDraggable(ok){
  ids.forEach(id=>{ const el=$(id); el.style.pointerEvents = ok ? "auto" : "none"; el.style.cursor = ok ? "move" : "default"; });
  st(ok ? "🛠 微調模式：拖曳 / 方向鍵（Shift×2.5） / S 複製座標 / E 退出"
        : "✅ 成功載入—F 全螢幕 / E 微調 / S 複製座標");
}
document.addEventListener("keydown", e=>{
  const k=e.key.toLowerCase();
  if(k==="e"){ tune=!tune; setDraggable(tune); }
  if(k==="s" && tune){
    const g=getComputedStyle(document.documentElement);
    const vars = ids.map(id=>{
      const top=g.getPropertyValue(`--${id}-top`).trim();
      const left=g.getPropertyValue(`--${id}-left`).trim();
      return `--${id}-top: ${top}; --${id}-left: ${left};`;
    }).join("\n");
    navigator.clipboard.writeText(vars);
    alert("已複製座標：\n\n"+vars+"\n\n貼回 :root 即可永久固定。");
  }
});
ids.forEach(id=>{
  const el=$(id);
  el.addEventListener("pointerdown", e=>{ if(!tune) return; active=el; current=id; el.setPointerCapture(e.pointerId); });
  el.addEventListener("pointermove", e=>{
    if(!tune || active!==el) return;
    const r=$("stage").getBoundingClientRect();
    const x=((e.clientX-r.left)/r.width)*100;
    const y=((e.clientY-r.top)/r.height)*100;
    document.documentElement.style.setProperty(`--${id}-left`, x.toFixed(2)+"%");
    document.documentElement.style.setProperty(`--${id}-top`,  y.toFixed(2)+"%");
  });
  el.addEventListener("pointerup", ()=>{ active=null; });
});
document.addEventListener("keydown", e=>{
  if(!tune || !current) return;
  const step = e.shiftKey ? 0.5 : 0.2;
  const g=getComputedStyle(document.documentElement);
  const rd=k=>parseFloat(g.getPropertyValue(k))||0;
  if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key)){
    e.preventDefault();
    let t=rd(`--${current}-top`), l=rd(`--${current}-left`);
    if(e.key==="ArrowLeft") l-=step;
    if(e.key==="ArrowRight") l+=step;
    if(e.key==="ArrowUp") t-=step;
    if(e.key==="ArrowDown") t+=step;
    document.documentElement.style.setProperty(`--${current}-top`,  t.toFixed(2)+"%");
    document.documentElement.style.setProperty(`--${current}-left`, l.toFixed(2)+"%");
  }
});
</script>
</body>
</html>
